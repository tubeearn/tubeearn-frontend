<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Forgot Password</title>
<style>
body,html {margin:0;padding:0;font-family:Arial,sans-serif;background:#f2f2f2;}
.page-wrapper {display:flex;justify-content:center;align-items:flex-start;min-height:100vh;padding-top:50px;}
.form-box {background:white;width:100%;max-width:450px;padding:25px;border-radius:8px;box-shadow:0 0 12px rgba(0,0,0,0.1);text-align:center;}
h2 {color:#333;}
input {width:90%;padding:10px;margin:8px 0;border:1px solid #ccc;border-radius:5px;font-size:15px;}
button {padding:10px 20px;background:#2575fc;color:white;border:none;border-radius:5px;cursor:pointer;font-size:15px;}
button:hover {background:#1a5fd1;}
small {display:block;font-size:13px;color:red;min-height:18px;}
.success {color:green;}
</style>
</head>
<body>
<div class="page-wrapper">
<div class="form-box">
<h2>Forgot Password</h2>

<!-- Step 1 -->
<div id="step1">
    <input type="email" id="email" placeholder="Enter Registered Email">
    <small id="emailError"></small>
    <button onclick="sendOTP()">Send OTP</button>
</div>

<!-- Step 2 -->
<div id="step2" style="display:none;">
    <input type="text" id="otp" placeholder="Enter OTP">
    <small id="otpError"></small>
    <button onclick="verifyOTP()">Verify OTP</button>
</div>

<!-- Step 3 -->
<div id="step3" style="display:none;">
    <input type="password" id="newPass" placeholder="Enter new password">
    <small>Password must contain 1 uppercase, 1 number & 1 symbol</small>
    <input type="password" id="confirmPass" placeholder="Confirm password">
    <small id="passError"></small>
    <button onclick="updatePassword()">Submit</button>
</div>

<p id="successMsg" class="success"></p>
</div>
</div>

<!-- Config (root से लोड) -->
<script src="../configuration.js"></script>

<script>
// Step 1: Send OTP
function sendOTP(){
    const email = document.getElementById("email").value.trim();
    const emailError = document.getElementById("emailError");
    emailError.innerText = "";
    if(!email){ emailError.innerText = "Please enter your email"; return; }

    emailError.innerText = "Sending OTP...";
    fetch(`${API_BASE}/forgot/send-otp`, {
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ email })
    })
    .then(res=>res.json())
    .then(data=>{
        if(data.success){
            sessionStorage.setItem("resetEmail", email);
            document.getElementById("step1").style.display="none";
            document.getElementById("step2").style.display="block";
        } else {
            emailError.innerText = data.message || "Failed to send OTP";
        }
    })
    .catch(()=> emailError.innerText = "Server error");
}

// Step 2: Verify OTP
function verifyOTP(){
    const email = sessionStorage.getItem("resetEmail");
    const otp = document.getElementById("otp").value.trim();
    const otpError = document.getElementById("otpError");
    otpError.innerText = "";
    if(!otp){ otpError.innerText = "Enter OTP"; return; }

    otpError.innerText = "Verifying...";
    fetch(`${API_BASE}/forgot/verify-otp`, {
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ email, otp })
    })
    .then(res=>res.json())
    .then(data=>{
        if(data.success){
            document.getElementById("step2").style.display="none";
            document.getElementById("step3").style.display="block";
        } else {
            otpError.innerText = data.message || "Invalid OTP";
        }
    })
    .catch(()=> otpError.innerText = "Server error");
}

// Step 3: Update Password
function updatePassword(){
    const email = sessionStorage.getItem("resetEmail");
    const newPass = document.getElementById("newPass").value.trim();
    const confirmPass = document.getElementById("confirmPass").value.trim();
    const passError = document.getElementById("passError");
    const successMsg = document.getElementById("successMsg");

    passError.innerText = "";
    successMsg.innerText = "";

    const passRegex=/^(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#\$%\^&\*]).{6,}$/;
    if(!passRegex.test(newPass)){ passError.innerText = "Password must be strong"; return; }
    if(newPass !== confirmPass){ passError.innerText = "Passwords do not match"; return; }

    passError.innerText = "Updating...";
    fetch(`${API_BASE}/forgot/update-password`, {
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ email, password:newPass })
    })
    .then(res=>res.json())
    .then(data=>{
        if(data.success){
            successMsg.innerText = "Password changed successfully! Redirecting...";
            passError.innerText = "";
            sessionStorage.removeItem("resetEmail");
            setTimeout(()=> window.location.href="login.html", 2000);
        } else {
            passError.innerText = data.message || "Update failed";
        }
    })
    .catch(()=> passError.innerText = "Server error");
}
</script>

</body>
</html>
